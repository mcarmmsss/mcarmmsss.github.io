<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üå∏ Mc's Workspace üå∏</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Montserrat',sans-serif; background:#ffeaf3 url('images/bg.jpg') center/cover no-repeat fixed; color:#5a3b4d; min-height:100vh; }
    header { text-align:center; padding:20px; font-size:2.2rem; font-weight:600; background:#ffd6e8; border-bottom:4px solid #ff9fcf; }
    .container { display:grid; grid-template-columns:2fr 1fr; gap:20px; padding:20px; max-width:1400px; margin:0 auto; }
    .card { background:rgba(255,255,255,0.92); border-radius:20px; padding:20px; box-shadow:0 8px 20px rgba(0,0,0,0.1); border:2px solid #ffccdd; }
    h2 { margin-top:0; color:#ff7fbf; display:flex; align-items:center; gap:8px; }
    button { background:#ff9fcf; border:none; padding:12px 18px; border-radius:999px; cursor:pointer; font-family:'Montserrat',sans-serif; margin:6px 4px; color:white; font-weight:600; }
    button:hover { background:#ff7fbf; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .choices button { min-width:140px; margin:8px; }
    select,input,textarea { width:100%; padding:10px; border-radius:12px; border:2px solid #ffccdd; margin-bottom:12px; font-family:'Montserrat',sans-serif; box-sizing:border-box; }
    textarea { height:140px; }
    .timer { font-size:2.2rem; text-align:center; margin:15px 0; color:#ff7fbf; font-weight:600; }
    .sparkle { position:fixed; font-size:2rem; animation:pop 0.8s ease-out forwards; pointer-events:none; }
    @keyframes pop { from{opacity:1;transform:scale(1);} to{opacity:0;transform:scale(2.5);} }
    .sticker { position:fixed; width:80px; opacity:0.9; pointer-events:none; animation:float 6s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0) rotate(0deg);} 50%{transform:translateY(-20px) rotate(5deg);} }
    #customizer { display:none; margin-top:20px; padding:15px; background:#fff5f9; border-radius:16px; border:2px dashed #ffccdd; }
    #customizer.show { display:block; animation:slideDown 0.4s ease-out; }
    @keyframes slideDown { from{opacity:0;transform:translateY(-10px);} to{opacity:1;transform:translateY(0);} }
    label { display:block; margin-top:12px; font-weight:600; color:#ff7fbf; }
    #typedAnswer { font-size:1.2rem; }
    #feedback { font-size:1.3rem; margin:15px 0; min-height:1.5em; }
    .deck-adder input { margin-bottom:8px; }
    .card-list { max-height:200px; overflow-y:auto; margin:10px 0; padding:10px; background:#fff8fb; border-radius:10px; font-size:0.95rem; }
  </style>
</head>
<body>

<header>üå∏ Mc's Workspace üå∏ üíï</header>

<div class="container">
  <!-- FLASHCARDS -->
  <div class="card">
    <h2>üìö Flashcards üíñ</h2>
    <select id="deckSelect"></select>
    <select id="modeSelect" style="margin:10px 0;">
      <option value="multiple">Multiple Choice (Term ‚Üí Description)</option>
      <option value="reversed">Reversed MC (Description ‚Üí Term)</option>
      <option value="identification">Identification (Type the Term/Name)</option>
    </select>
    <p id="question" style="font-size:1.4rem; margin:20px 0;"></p>
    <div id="choices" class="choices"></div>
    <div id="typedArea" style="display:none;">
      <input type="text" id="typedAnswer" placeholder="Type the term/name here...">
      <button onclick="checkTyped()">Submit ‚ô°</button>
      <div id="feedback"></div>
    </div>
    <p>Score: <span id="score">0</span> üéÄ <span id="savedScore"></span></p>
    <button id="nextBtn" onclick="nextQuestion()" disabled>Next ‚ô°</button>
  </div>

  <!-- SIDE PANEL -->
  <div class="card">
    <h2>üìù Notes üéÄ</h2>
    <textarea placeholder="Jot down your cute thoughts here... üí≠"></textarea>

    <h2>‚è± Pomodoro with Kitty</h2>
    <div style="text-align:center; margin:15px 0;">
      <img src="images/hello-kitty-study.png" style="width:140px; margin-bottom:10px;" alt="kitty studying">
      <p style="color:#ff9fcf; font-weight:600;">Study hard, meow meow! ‚ô°</p>
    </div>
    <input id="activityInput" placeholder="What are you working on right now?">
    <div class="timer" id="timer">25:00</div>
    <button onclick="startPomodoro()">Start Your Session üéÄ</button>
    <button onclick="pausePomodoro()">Pause ‚è∏Ô∏è</button>
    <button onclick="resetPomodoro()">Reset ‚ô°</button>
    <button onclick="testSound()" style="background:#ffb6c1; margin-left:10px;">Test Sound ‚ô°</button>
    <ul id="log" style="list-style:none; padding:0; margin-top:15px;"></ul>

    <button onclick="toggleCustomizer()" style="margin-top:20px; background:#ff69b4;">‚ú® Customize Stickers</button>

    <div id="customizer">
      <h2 style="margin-top:0;">üéÄ Change Your Stickers!</h2>
      <p style="font-size:0.9rem; color:#888;">File names or URLs ‚ô°</p>
      <label>Hello Kitty main:</label><input id="img1" value="hello-kitty.png">
      <label>My Melody:</label><input id="img2" value="my-melody.png">
      <label>Cinnamoroll:</label><input id="img3" value="cinnamoroll.png">
      <label>Kuromi:</label><input id="img4" value="kuromi.png">
      <label>Extra Hello Kitty:</label><input id="img5" value="hello-kitty2.png">
      <label>Study Kitty:</label><input id="imgStudy" value="hello-kitty-study.png">
      <button onclick="updateImages()" style="background:#ff69b4; margin-top:15px;">Update ‚ô°</button>
    </div>

    <!-- Deck Adder -->
    <h2 style="margin-top:25px;">‚ûï Add Cards</h2>
    <select id="addDeckSelect"></select>
    <input id="newDeckName" placeholder="Or type new deck name..." style="margin-top:8px;">
    <input id="newTerm" placeholder="Term / Name">
    <textarea id="newDef" placeholder="Description / Definition"></textarea>
    <button onclick="addCard()">Add Card ‚Üí</button>
    <div id="currentCards" class="card-list"></div>
  </div>
</div>

<!-- FLOATING STICKERS -->
<img src="images/hello-kitty.png" class="sticker" style="bottom:30px;right:40px;">
<img src="images/my-melody.png" class="sticker" style="top:80px;left:50px;width:90px;animation-delay:1s;">
<img src="images/cinnamoroll.png" class="sticker" style="bottom:120px;left:60px;width:70px;animation-delay:2s;">
<img src="images/kuromi.png" class="sticker" style="top:150px;right:70px;width:85px;animation-delay:3s;">
<img src="images/hello-kitty2.png" class="sticker" style="bottom:200px;right:150px;width:60px;animation-delay:1.5s;">

<!-- Pomodoro Finish Sound -->
<audio id="finishSound" preload="auto">
  <source src="sounds/finish.mp3" type="audio/mpeg">
  Your browser doesn't support audio.
</audio>

<script src="decks.js"></script>
<script>
// Normalize for accents/special chars
function normalize(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
}

// Decks from localStorage or fallback to decks.js
let allDecks = JSON.parse(localStorage.getItem("userDecks")) || { ...decks };
if (Object.keys(allDecks).length === 0) {
  allDecks = { ...decks };
  localStorage.setItem("userDecks", JSON.stringify(allDecks));
}

let currentDeck = [];
let shuffledDeck = [];
let index = 0;
let score = 0;
let answered = false;
let currentMode = 'multiple';

const deckSelect = document.getElementById("deckSelect");
const addDeckSelect = document.getElementById("addDeckSelect");
const modeSelect = document.getElementById("modeSelect");
const questionEl = document.getElementById("question");
const choicesEl = document.getElementById("choices");
const typedArea = document.getElementById("typedArea");
const typedInput = document.getElementById("typedAnswer");
const feedbackEl = document.getElementById("feedback");
const scoreEl = document.getElementById("score");
const savedScoreEl = document.getElementById("savedScore");
const nextBtn = document.getElementById("nextBtn");

// Populate decks
function populateDecks() {
  deckSelect.innerHTML = "";
  addDeckSelect.innerHTML = '<option value="">-- Select or create new --</option>';
  Object.keys(allDecks).sort().forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name.replace(/_/g, " ").toUpperCase() + " ‚ô°";
    deckSelect.appendChild(opt.cloneNode(true));
    addDeckSelect.appendChild(opt);
  });
}
populateDecks();

deckSelect.onchange = loadDeck;
modeSelect.onchange = () => { currentMode = modeSelect.value; showQuestion(); };
addDeckSelect.onchange = updateCurrentCardsList;

function shuffleArray(array) {
  const copy = [...array];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

function loadDeck() {
  const deckName = deckSelect.value;
  currentDeck = allDecks[deckName] || [];
  shuffledDeck = shuffleArray(currentDeck);
  index = 0;
  score = parseInt(localStorage.getItem(`score_${deckName}`)) || 0;
  scoreEl.textContent = score;
  savedScoreEl.textContent = `(saved: ${score})`;
  answered = false;
  nextBtn.disabled = true;
  showQuestion();
  updateCurrentCardsList();
}

function showQuestion() {
  if (!shuffledDeck.length) {
    questionEl.textContent = "No cards yet... add some below! üíï";
    choicesEl.innerHTML = "";
    typedArea.style.display = "none";
    nextBtn.disabled = true;
    return;
  }

  const card = shuffledDeck[index];
  const term = card[0];
  const answer = card[1];

  choicesEl.innerHTML = "";
  typedArea.style.display = "none";
  feedbackEl.textContent = "";
  answered = false;
  nextBtn.disabled = true;

  const allTerms = currentDeck.map(c => c[0]);
  const allDefs = currentDeck.map(c => c[1]);

  if (currentMode === 'multiple') {
    questionEl.textContent = term;
    let options = [answer];
    while (options.length < 4 && allDefs.length > options.length) {
      const rand = allDefs[Math.floor(Math.random() * allDefs.length)];
      if (!options.includes(rand)) options.push(rand);
    }
    options.sort(() => Math.random() - 0.5);
    options.forEach(ch => {
      const btn = document.createElement("button");
      btn.textContent = ch;
      btn.onclick = () => checkAnswer(ch, answer, btn);
      choicesEl.appendChild(btn);
    });
  } else if (currentMode === 'reversed') {
    questionEl.textContent = answer;
    let options = [term];
    while (options.length < 4 && allTerms.length > options.length) {
      const rand = allTerms[Math.floor(Math.random() * allTerms.length)];
      if (!options.includes(rand)) options.push(rand);
    }
    options.sort(() => Math.random() - 0.5);
    options.forEach(ch => {
      const btn = document.createElement("button");
      btn.textContent = ch;
      btn.onclick = () => checkAnswer(ch, term, btn);
      choicesEl.appendChild(btn);
    });
  } else if (currentMode === 'identification') {
    questionEl.textContent = answer;
    typedArea.style.display = "block";
    typedInput.value = "";
    typedInput.focus();
  }
}

function checkAnswer(choice, correct, btn) {
  if (answered) return;
  answered = true;
  nextBtn.disabled = false;
  if (choice === correct) {
    score++;
    scoreEl.textContent = score;
    savedScoreEl.textContent = `(saved: ${score})`;
    localStorage.setItem(`score_${deckSelect.value}`, score);
    sparkle();
    btn.style.background = "#c3f0c8";
    btn.style.border = "3px solid #4caf50";
  } else {
    btn.style.background = "#ffcccc";
    btn.style.border = "3px solid #e74c3c";
    [...choicesEl.children].forEach(b => {
      if (b.textContent === correct) {
        b.style.background = "#c3f0c8";
        b.style.border = "3px solid #4caf50";
      }
    });
  }
}

function checkTyped() {
  if (answered) return;
  const user = normalize(typedInput.value);
  const correct = normalize(shuffledDeck[index][0]);
  answered = true;
  nextBtn.disabled = false;
  if (user === correct) {
    score++;
    scoreEl.textContent = score;
    savedScoreEl.textContent = `(saved: ${score})`;
    localStorage.setItem(`score_${deckSelect.value}`, score);
    sparkle();
    feedbackEl.innerHTML = "Correct! üå∏üíñ";
    feedbackEl.style.color = "#4caf50";
  } else {
    feedbackEl.innerHTML = `No... it's <strong>${shuffledDeck[index][0]}</strong>`;
    feedbackEl.style.color = "#e74c3c";
  }
}

function nextQuestion() {
  index = (index + 1) % shuffledDeck.length;
  showQuestion();
}

function sparkle() {
  const emojis = ["‚ú®","üå∏","üíñ","üéÄ","üê±","üçì","üç∞","‚ù§Ô∏è"];
  const s = document.createElement("div");
  s.className = "sparkle";
  s.textContent = emojis[Math.floor(Math.random()*emojis.length)];
  s.style.left = Math.random()*window.innerWidth + "px";
  s.style.top = Math.random()*window.innerHeight + "px";
  document.body.appendChild(s);
  setTimeout(() => s.remove(), 800);
}

// Pomodoro with Pause/Resume
let time = 1500;
let interval = null;
let isPaused = false;

function startPomodoro() {
  if (interval || isPaused) return;
  interval = setInterval(() => {
    if (time <= 0) {
      clearInterval(interval);
      interval = null;
      isPaused = false;
      logSession();
      alert("Great job cutie! Take a break ‚ô°");
      return;
    }
    time--;
    updateTimer();
  }, 1000);
  document.querySelector('button[onclick="pausePomodoro()"]').textContent = "Pause ‚è∏Ô∏è";
}

function pausePomodoro() {
  if (!interval && !isPaused) return;
  if (interval) {
    clearInterval(interval);
    interval = null;
    isPaused = true;
    document.querySelector('button[onclick="pausePomodoro()"]').textContent = "Resume ‚ñ∂Ô∏è";
  } else if (isPaused) {
    isPaused = false;
    startPomodoro();  // resume
  }
}

function resetPomodoro() {
  clearInterval(interval);
  interval = null;
  isPaused = false;
  time = 1500;
  updateTimer();
  document.querySelector('button[onclick="pausePomodoro()"]').textContent = "Pause ‚è∏Ô∏è";
}

function updateTimer() {
  const m = String(Math.floor(time/60)).padStart(2,"0");
  const s = String(time%60).padStart(2,"0");
  document.getElementById("timer").textContent = `${m}:${s}`;
}

function logSession() {
  const text = document.getElementById("activityInput").value.trim() || "Kawaii Study Time";
  const li = document.createElement("li");
  li.textContent = `25 min ‚Äì ${text} üéÄ`;
  li.style.margin = "8px 0";
  document.getElementById("log").appendChild(li);

  const sound = document.getElementById("finishSound");
  sound.currentTime = 0;
  sound.play().catch(() => {});
}

function testSound() {
  const sound = document.getElementById("finishSound");
  sound.currentTime = 0;
  sound.play()
    .then(() => console.log("Sound played successfully!"))
    .catch(e => {
      console.error("Sound play failed:", e);
      alert("Sound didn't play! Reasons:\n1. Clicked 'Test Sound' too early? Try clicking anywhere on page first.\n2. File path wrong? Check 'sounds/finish.mp3' exists.\n3. Browser blocked local file audio? Try in Firefox or serve via local server.\n\nCheck console (F12) for details.");
    });
}

// Deck adder
function addCard() {
  let deckName = addDeckSelect.value || document.getElementById("newDeckName").value.trim().toLowerCase().replace(/\s+/g, '_');
  if (!deckName) return alert("Pick or type a deck name!");
  const term = document.getElementById("newTerm").value.trim();
  const def = document.getElementById("newDef").value.trim();
  if (!term || !def) return alert("Fill term and definition!");
  if (!allDecks[deckName]) allDecks[deckName] = [];
  allDecks[deckName].push([term, def]);
  localStorage.setItem("userDecks", JSON.stringify(allDecks));
  populateDecks();
  if (deckSelect.value === deckName) loadDeck();
  updateCurrentCardsList();
  document.getElementById("newTerm").value = "";
  document.getElementById("newDef").value = "";
  document.getElementById("newDeckName").value = "";
}

function updateCurrentCardsList() {
  const list = document.getElementById("currentCards");
  const deckName = addDeckSelect.value;
  list.innerHTML = deckName && allDecks[deckName] ? allDecks[deckName].map((c,i) => `<div><strong>${i+1}.</strong> ${c[0]} ‚Üí ${c[1]}</div>`).join("") : "<em>Select a deck to see cards</em>";
}

// Customizer
function toggleCustomizer() { document.getElementById("customizer").classList.toggle("show"); }
function updateImages() {
  document.querySelectorAll('.sticker').forEach((s,i) => { const v = document.getElementById(`img${i+1}`).value; if (v) s.src = v; });
  const study = document.querySelector('.card img[src*="hello-kitty-study"]');
  if (study) study.src = document.getElementById("imgStudy").value;
  sparkle();
}

// Init
loadDeck();
</script>
</body>
</html>